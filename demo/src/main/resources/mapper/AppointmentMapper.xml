<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.AppointmentMapper">

    <!-- 根据用户ID分页查询预约列表 -->
    <select id="selectByUserId" resultType="com.example.demo.entity.Appointment">
        SELECT 
            a.*,
            m.merchant_name as merchantName,
            (SELECT GROUP_CONCAT(si.item_name SEPARATOR ', ')
             FROM appointment_service_item asi
             LEFT JOIN service_item si ON asi.service_item_id = si.id
             WHERE asi.appointment_id = a.id) as serviceItemName
        FROM appointment a
        LEFT JOIN merchant m ON a.merchant_id = m.id
        WHERE a.user_id = #{userId}
        ORDER BY a.create_time DESC
    </select>

    <!-- 根据商家ID分页查询预约列表 -->
    <select id="selectByMerchantId" resultType="com.example.demo.entity.Appointment">
        SELECT 
            a.*,
            u.username as userName,
            mc.brand as motorcycleBrand,
            mc.model as motorcycleModel,
            mc.license_plate as licensePlate,
            (SELECT GROUP_CONCAT(si.item_name SEPARATOR ', ')
             FROM appointment_service_item asi
             LEFT JOIN service_item si ON asi.service_item_id = si.id
             WHERE asi.appointment_id = a.id) as serviceItemName
        FROM appointment a
        LEFT JOIN sys_user u ON a.user_id = u.id
        LEFT JOIN motorcycle mc ON a.motorcycle_id = mc.id
        WHERE a.merchant_id = #{merchantId}
        <if test="status != null">
            AND a.status = #{status}
        </if>
        ORDER BY a.create_time DESC
    </select>

</mapper>

